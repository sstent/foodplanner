{% extends "base.html" %}
{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-file-earmark-text"></i> Meal Templates</h2>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTemplateModal">
                <i class="bi bi-plus-circle"></i> Create Template
            </button>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Your Templates</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="templatesTable">
                        <thead>
                            <tr>
                                <th>Template Name</th>
                                <th>Meals Assigned</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Templates will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Template Modal -->
<div class="modal fade" id="createTemplateModal" tabindex="-1" aria-labelledby="createTemplateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createTemplateModalLabel">Create New Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createTemplateForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="templateName" class="form-label">Template Name</label>
                        <input type="text" class="form-control" id="templateName" name="name" required>
                    </div>

                    <h6 class="mb-3">Assign Meals to Meal Times</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="breakfast" class="form-label">Breakfast</label>
                                <select class="form-control meal-select" id="breakfast" name="breakfast">
                                    <option value="">Select meal...</option>
                                    {% for meal in meals %}
                                    <option value="{{ meal.id }}">{{ meal.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="lunch" class="form-label">Lunch</label>
                                <select class="form-control meal-select" id="lunch" name="lunch">
                                    <option value="">Select meal...</option>
                                    {% for meal in meals %}
                                    <option value="{{ meal.id }}">{{ meal.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="dinner" class="form-label">Dinner</label>
                                <select class="form-control meal-select" id="dinner" name="dinner">
                                    <option value="">Select meal...</option>
                                    {% for meal in meals %}
                                    <option value="{{ meal.id }}">{{ meal.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="snack1" class="form-label">Snack 1</label>
                                <select class="form-control meal-select" id="snack1" name="snack1">
                                    <option value="">Select meal...</option>
                                    {% for meal in meals %}
                                    <option value="{{ meal.id }}">{{ meal.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="snack2" class="form-label">Snack 2</label>
                                <select class="form-control meal-select" id="snack2" name="snack2">
                                    <option value="">Select meal...</option>
                                    {% for meal in meals %}
                                    <option value="{{ meal.id }}">{{ meal.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="beverage1" class="form-label">Beverage 1</label>
                                <select class="form-control meal-select" id="beverage1" name="beverage1">
                                    <option value="">Select meal...</option>
                                    {% for meal in meals %}
                                    <option value="{{ meal.id }}">{{ meal.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="beverage2" class="form-label">Beverage 2</label>
                                <select class="form-control meal-select" id="beverage2" name="beverage2">
                                    <option value="">Select meal...</option>
                                    {% for meal in meals %}
                                    <option value="{{ meal.id }}">{{ meal.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Template</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Template Modal -->
<div class="modal fade" id="editTemplateModal" tabindex="-1" aria-labelledby="editTemplateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTemplateModalLabel">Edit Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editTemplateForm">
                <div class="modal-body">
                    <input type="hidden" id="editTemplateId" name="id">
                    <div class="mb-3">
                        <label for="editTemplateName" class="form-label">Template Name</label>
                        <input type="text" class="form-control" id="editTemplateName" name="name" required>
                    </div>

                    <h6 class="mb-3">Assign Meals to Meal Times</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_breakfast" class="form-label">Breakfast</label>
                                <select class="form-control meal-select" id="edit_breakfast" name="breakfast">
                                    <option value="">Select meal...</option>
                                    {% for meal in meals %}
                                    <option value="{{ meal.id }}">{{ meal.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_lunch" class="form-label">Lunch</label>
                                <select class="form-control meal-select" id="edit_lunch" name="lunch">
                                    <option value="">Select meal...</option>
                                    {% for meal in meals %}
                                    <option value="{{ meal.id }}">{{ meal.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_dinner" class="form-label">Dinner</label>
                                <select class="form-control meal-select" id="edit_dinner" name="dinner">
                                    <option value="">Select meal...</option>
                                    {% for meal in meals %}
                                    <option value="{{ meal.id }}">{{ meal.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_snack1" class="form-label">Snack 1</label>
                                <select class="form-control meal-select" id="edit_snack1" name="snack1">
                                    <option value="">Select meal...</option>
                                    {% for meal in meals %}
                                    <option value="{{ meal.id }}">{{ meal.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_snack2" class="form-label">Snack 2</label>
                                <select class="form-control meal-select" id="edit_snack2" name="snack2">
                                    <option value="">Select meal...</option>
                                    {% for meal in meals %}
                                    <option value="{{ meal.id }}">{{ meal.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_beverage1" class="form-label">Beverage 1</label>
                                <select class="form-control meal-select" id="edit_beverage1" name="beverage1">
                                    <option value="">Select meal...</option>
                                    {% for meal in meals %}
                                    <option value="{{ meal.id }}">{{ meal.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_beverage2" class="form-label">Beverage 2</label>
                                <select class="form-control meal-select" id="edit_beverage2" name="beverage2">
                                    <option value="">Select meal...</option>
                                    {% for meal in meals %}
                                    <option value="{{ meal.id }}">{{ meal.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Template</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Use Template Modal -->
<div class="modal fade" id="useTemplateModal" tabindex="-1" aria-labelledby="useTemplateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="useTemplateModalLabel">Use Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="useTemplateForm">
                <div class="modal-body">
                    <p>Copy template meals to your plan for the selected date:</p>
                    <div class="mb-3">
                        <label for="startDate" class="form-label">Select Date</label>
                        <input type="date" class="form-control" id="startDate" name="start_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="person" class="form-label">Person</label>
                        <select class="form-control" id="person" name="person" required>
                            <option value="Person A">Person A</option>
                            <option value="Person B">Person B</option>
                        </select>
                    </div>
                    <div id="overwriteWarning" class="alert alert-warning" style="display: none;">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Warning:</strong> There are already meals planned for this date.
                        Applying the template will overwrite them.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Use Template</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let currentTemplateId = null;

document.addEventListener('DOMContentLoaded', function() {
    loadTemplates();

    // Handle template creation
    document.getElementById('createTemplateForm').addEventListener('submit', function(e) {
        e.preventDefault();
        createTemplate();
    });

    // Handle template usage
    document.getElementById('useTemplateForm').addEventListener('submit', function(e) {
        e.preventDefault();
        useTemplate();
    });

    document.getElementById('editTemplateForm').addEventListener('submit', function(e) {
        e.preventDefault();
        updateTemplate();
    });
});

function loadTemplates() {
    fetch('/templates')
        .then(response => response.text())
        .then(html => {
            // Extract templates data from the HTML response
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const templates = JSON.parse(doc.querySelector('script[data-templates]')?.textContent || '[]');

            const tbody = document.querySelector('#templatesTable tbody');
            tbody.innerHTML = '';

            if (templates.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No templates created yet. Click "Create Template" to get started.</td></tr>';
                return;
            }

            templates.forEach(template => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${template.name}</strong></td>
                    <td>
                        ${template.template_meals && template.template_meals.length > 0 ? template.template_meals.map(tm =>
                            `<span class="badge bg-secondary me-1">${tm.meal_time}: ${tm.meal.name}</span>`
                        ).join('') : 'No meals assigned'}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="editTemplate(${template.id})">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteTemplate(${template.id})">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        })
        .catch(error => {
            console.error('Error loading templates:', error);
        });
}

function createTemplate() {
    const form = document.getElementById('createTemplateForm');
    const formData = new FormData(form);

    // Build meal assignments string
    const mealTimes = ['breakfast', 'lunch', 'dinner', 'snack1', 'snack2', 'beverage1', 'beverage2'];
    const assignments = [];

    mealTimes.forEach(mealTime => {
        const mealId = formData.get(mealTime);
        if (mealId) {
            const displayName = mealTime.charAt(0).toUpperCase() + mealTime.slice(1).replace('1', ' 1').replace('2', ' 2');
            assignments.push(`${displayName}:${mealId}`);
        }
    });

    const data = {
        name: formData.get('name'),
        meal_assignments: assignments.join(',')
    };

    fetch('/templates/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            bootstrap.Modal.getInstance(document.getElementById('createTemplateModal')).hide();
            form.reset();
            loadTemplates();
        } else {
            alert('Error creating template: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating template');
    });
}

async function editTemplate(templateId) {
    try {
        const response = await fetch(`/templates/${templateId}`);
        const data = await response.json();

        if (data.status === 'success') {
            const template = data.template;
            document.getElementById('editTemplateId').value = template.id;
            document.getElementById('editTemplateName').value = template.name;

            // Clear previous selections
            const mealSelects = document.querySelectorAll('#editTemplateForm .meal-select');
            mealSelects.forEach(select => select.value = '');

            // Set current meal assignments
            template.template_meals.forEach(tm => {
                const select = document.getElementById(`edit_${tm.meal_time.toLowerCase().replace(' ', '')}`);
                if (select) {
                    select.value = tm.meal_id;
                }
            });

            new bootstrap.Modal(document.getElementById('editTemplateModal')).show();
        } else {
            alert('Error loading template details: ' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error loading template details.');
    }
}

function updateTemplate() {
    const form = document.getElementById('editTemplateForm');
    const formData = new FormData(form);
    const templateId = formData.get('id');

    const mealTimes = ['breakfast', 'lunch', 'dinner', 'snack1', 'snack2', 'beverage1', 'beverage2'];
    const assignments = [];

    mealTimes.forEach(mealTime => {
        const mealId = formData.get(mealTime);
        if (mealId) {
            const displayName = mealTime.charAt(0).toUpperCase() + mealTime.slice(1).replace('1', ' 1').replace('2', ' 2');
            assignments.push(`${displayName}:${mealId}`);
        }
    });

    const data = {
        name: formData.get('name'),
        meal_assignments: assignments.join(',')
    };

    fetch(`/templates/${templateId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            bootstrap.Modal.getInstance(document.getElementById('editTemplateModal')).hide();
            loadTemplates();
        } else {
            alert('Error updating template: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating template');
    });
}

function deleteTemplate(templateId) {
    if (!confirm('Are you sure you want to delete this template?')) {
        return;
    }

    fetch(`/templates/${templateId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            loadTemplates();
        } else {
            alert('Error deleting template: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting template');
    });
}
</script>

<!-- Hidden script to pass templates data -->
<script type="application/json" data-templates>
{{ templates|tojson }}
</script>
{% endblock %}